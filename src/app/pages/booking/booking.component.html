<div class="booking-page">
    <div class="booking-container">
        <h1 class="page-title">
            Book Your VR Experience
        </h1>

        @if (loading()) {
            <app-loading
                    [message]="'booking.loading' | translate : { default: 'Loadingâ€¦' }"
                    [fullscreen]="true">
            </app-loading>
        } @else {

            <!-- ðŸ”¹ REUSED SUMMARY BAR -->
            @if (currentStep() > 1) {
                <app-summary-bar
                        [date]="selectedDate() || null"
                        [time]="selectedTime()"
                        [rooms]="selectedRooms()"
                        [gamesText]="getSelectedGamesText()"
                        [totalPlayers]="getTotalPlayers()">
                </app-summary-bar>
            }

            <div class="booking-steps">
                <!-- ðŸ”¹ Step indicator uses global card feel -->
                <div class="steps-indicator card">
                    <div class="step" [class.active]="currentStep() >= 1" [class.completed]="currentStep() > 1">
                        <div class="step-number">1</div>
                        <div class="step-label">Choose Date &amp; Time</div>
                    </div>
                    <div class="step-line" [class.completed]="currentStep() > 1"></div>

                    <div class="step" [class.active]="currentStep() >= 2" [class.completed]="currentStep() > 2">
                        <div class="step-number">2</div>
                        <div class="step-label">Select Game</div>
                    </div>
                    <div class="step-line" [class.completed]="currentStep() > 2"></div>

                    <div class="step" [class.active]="currentStep() >= 3" [class.completed]="currentStep() > 3">
                        <div class="step-number">3</div>
                        <div class="step-label">Players &amp; Details</div>
                    </div>
                    <div class="step-line" [class.completed]="currentStep() > 3"></div>

                    <div class="step" [class.active]="currentStep() >= 4">
                        <div class="step-number">4</div>
                        <div class="step-label">Payment</div>
                    </div>
                </div>

                <!-- STEP 1 â€“ Calendar -->
                @if (currentStep() === 1) {
                    <div class="step-content card">
                        <h2>Select Available Date &amp; Time</h2>
                        <p class="step-description">
                            Choose your preferred date and time. Green slots are available â€” click to select how many
                            rooms you need.
                        </p>

                        <app-calendar
                                [gameId]="calendarGameCode()"
                                [lang]="'en'"
                                [maxConcurrentBookings]="maxConcurrentBookings()"
                                (slotSelected)="onSlotSelected($event)"
                                (gamePickRequested)="onGamePickRequested($event)">
                        </app-calendar>

                        <div class="step-actions">
                            <app-button variant="outline" (clicked)="cancel()">Cancel</app-button>
                        </div>
                    </div>
                }

                <!-- STEP 2 â€“ Game selection -->
                @if (currentStep() === 2) {
                    <section>
                        <app-game-selection
                                [games]="games()"
                                [selectedRooms]="selectedRooms()"
                                [selected]="selectedGames()"
                                [canContinue]="allRoomsHaveGames()"
                                (selectGame)="selectGameForRoom($event.game, $event.roomIndex)"
                                (back)="previousStep()"
                                (continue)="nextStep()">
                        </app-game-selection>
                    </section>
                }

                <!-- STEP 3 â€“ Players -->
                @if (currentStep() === 3) {
                    <div class="step-content card">
                        <h2>Number of Players</h2>

                        @if (selectedRooms() === 1) {
                            <div class="form-section">
                                <h3>How many players?</h3>
                                <div class="player-selection">
                                    @for (num of playerOptionsForRoom(0); track num) {
                                        <div
                                                class="player-option"
                                                [class.selected]="getPlayersForRoom(0) === num"
                                                (click)="selectPlayersForRoom(num, 0)">
                                            <div class="player-count">{{ num }}</div>
                                            <div class="player-label">{{ num === 1 ? 'Player' : 'Players' }}</div>
                                            <div class="player-price">{{ pricePerPersonFor(num) * num }} MKD</div>
                                        </div>
                                    }
                                </div>
                            </div>
                        } @else {
                            <div class="multi-room-players">
                                @for (roomIndex of getRoomIndexes(); track roomIndex) {
                                    <div class="room-player-section">
                                        <h3 class="room-title-small">
                                            Room {{ roomIndex + 1 }}: {{ getGameNameForRoom(roomIndex) }}
                                        </h3>
                                        <div class="player-selection-compact">
                                            @for (num of playerOptionsForRoom(roomIndex); track num) {
                                                <div
                                                        class="player-option-compact"
                                                        [class.selected]="getPlayersForRoom(roomIndex) === num"
                                                        (click)="selectPlayersForRoom(num, roomIndex)">
                                                    <div class="player-count-compact">{{ num }}</div>
                                                    <div class="player-label-compact">
                                                        {{ num === 1 ? 'Player' : 'Players' }}
                                                    </div>
                                                    <div class="player-price-compact">
                                                        {{ pricePerPersonFor(num) * num }} MKD
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        }

                        <!-- ðŸ”¹ REUSED PRICE SUMMARY COMPONENT -->
                        @if (totalInclVat() > 0) {
                            <app-price-summary
                                    [net]="netPortion()"
                                    [vat]="vatPortion()"
                                    [total]="totalInclVat()"
                                    [taxPercent]="taxPercentage()"
                                    [currency]="'MKD'">
                            </app-price-summary>
                        }

                        <div class="step-actions">
                            <app-button variant="outline" (clicked)="previousStep()">Back</app-button>
                            <app-button (clicked)="nextStep()" [disabled]="!isStep3Valid()">
                                Continue to Payment
                            </app-button>
                        </div>
                    </div>
                }

                <!-- STEP 4 â€“ Payment -->
                @if (currentStep() === 4) {
                    <app-payment-step
                            [date]="formatDate(store.selectedDate())"
                            [time]="store.selectedTime()"
                            [rooms]="store.selectedRooms()"
                            [roomSummaries]="getRoomSummaries()"
                            [totalPlayers]="store.totalPlayers()"
                            [net]="store.netPortion()"
                            [vat]="store.vatPortion()"
                            [total]="store.finalTotalInclVat()"
                            [taxPercent]="store.taxPercentage()"
                            currency="MKD"

                            [paymentMethod]="store.paymentMethod()"
                            (paymentMethodChange)="store.setPaymentMethod($event)"

                            [customer]="store.customerInfo()"
                            (customerChange)="store.setCustomerInfo($event)"

                            [submitting]="submitting()"
                            (back)="previousStep()"
                            (submit)="submitBooking()">
                    </app-payment-step>
                }
            </div>
        }
    </div>
</div>
