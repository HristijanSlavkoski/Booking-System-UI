<div class="booking-page">
    <div class="booking-container">
        <h1 class="page-title">Book Your VR Experience</h1>

        @if (loading()) {
            <app-loading message="Loading..." [fullscreen]="true"></app-loading>
        } @else {

            @if (currentStep() > 1) {
                <div class="selection-summary-bar">
                    <div class="summary-item-bar">
                        <span class="summary-icon">ðŸ“…</span>
                        <div class="summary-info">
                            <span class="summary-label">Date &amp; Time</span>
                            <span class="summary-value">{{ formatDate(selectedDate()) }} at {{ selectedTime() }}</span>
                        </div>
                    </div>

                    @if (currentStep() >= 2) {
                        <div class="summary-item-bar">
                            <span class="summary-icon">ðŸšª</span>
                            <div class="summary-info">
                                <span class="summary-label">Rooms</span>
                                <span class="summary-value">
                                        {{ selectedRooms() }} {{ selectedRooms() === 1 ? 'Room' : 'Rooms' }}
                                      </span>
                            </div>
                        </div>
                    }

                    @if (currentStep() >= 3) {
                        <div class="summary-item-bar">
                            <span class="summary-icon">ðŸŽ®</span>
                            <div class="summary-info">
                                <span class="summary-label">{{ 'Game' }}</span>
                                <span class="summary-value">{{ getSelectedGamesText() }}</span>
                            </div>
                        </div>

                        <div class="summary-item-bar">
                            <span class="summary-icon">ðŸ‘¥</span>
                            <div class="summary-info">
                                <span class="summary-label">Players</span>
                                <span class="summary-value">{{ getTotalPlayers() }}</span>
                            </div>
                        </div>

                    }
                </div>
            }

            <div class="booking-steps">
                <div class="steps-indicator">
                    <div class="step" [class.active]="currentStep() >= 1" [class.completed]="currentStep() > 1">
                        <div class="step-number">1</div>
                        <div class="step-label">Choose Date &amp; Time</div>
                    </div>
                    <div class="step-line" [class.completed]="currentStep() > 1"></div>

                    <div class="step" [class.active]="currentStep() >= 2" [class.completed]="currentStep() > 2">
                        <div class="step-number">2</div>
                        <div class="step-label">Select Game</div>
                    </div>
                    <div class="step-line" [class.completed]="currentStep() > 2"></div>

                    <div class="step" [class.active]="currentStep() >= 3" [class.completed]="currentStep() > 3">
                        <div class="step-number">3</div>
                        <div class="step-label">Players &amp; Details</div>
                    </div>
                    <div class="step-line" [class.completed]="currentStep() > 3"></div>

                    <div class="step" [class.active]="currentStep() >= 4">
                        <div class="step-number">4</div>
                        <div class="step-label">Payment</div>
                    </div>
                </div>

                <!-- STEP 1 -->
                @if (currentStep() === 1) {
                    <div class="step-content">
                        <h2>Select Available Date &amp; Time</h2>
                        <p class="step-description">
                            Choose your preferred date and time. Green slots are available â€” click to select how many
                            rooms you need.
                        </p>

                        <app-calendar
                                [gameId]="calendarGameCode()"
                                [lang]="'en'"
                                [maxConcurrentBookings]="maxConcurrentBookings()"
                                (slotSelected)="onSlotSelected($event)"
                                (gamePickRequested)="onGamePickRequested($event)">
                        </app-calendar>

                        <div class="step-actions">
                            <app-button variant="outline" (clicked)="cancel()">Cancel</app-button>
                        </div>
                    </div>
                }

                <!-- STEP 2 -->
                @if (currentStep() === 2) {
                    <section *ngIf="currentStep() === 2">
                        <app-game-selection
                                [games]="games()"
                                [selectedRooms]="selectedRooms()"
                                [selected]="selectedGames()"
                                (selectGame)="selectGameForRoom($event.game, $event.roomIndex)">
                        </app-game-selection>

                        <div class="step-actions">
                            <app-button variant="outline" (clicked)="previousStep()">Back</app-button>
                            <app-button (clicked)="nextStep()" [disabled]="!allRoomsHaveGames()">
                                Continue to Players &amp; Details
                            </app-button>
                        </div>
                    </section>
                }

                <!-- STEP 3 -->
                @if (currentStep() === 3) {
                    <div class="step-content">
                        <h2>Number of Players &amp; Customer Information</h2>

                        @if (selectedRooms() === 1) {
                            <div class="form-section">
                                <h3>How many players?</h3>
                                <div class="player-selection">
                                    @for (num of playerOptionsForRoom(0); track num) {
                                        <div
                                                class="player-option"
                                                [class.selected]="getPlayersForRoom(0) === num"
                                                (click)="selectPlayersForRoom(num, 0)">
                                            <div class="player-count">{{ num }}</div>
                                            <div class="player-label">{{ num === 1 ? 'Player' : 'Players' }}</div>
                                            <div class="player-price">{{ pricePerPersonFor(num) * num }}MKD
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        } @else {
                            <div class="multi-room-players">
                                @for (roomIndex of getRoomIndexes(); track roomIndex) {
                                    <div class="room-player-section">
                                        <h3 class="room-title-small">
                                            Room {{ roomIndex + 1 }}: {{ getGameNameForRoom(roomIndex) }}
                                        </h3>
                                        <div class="player-selection-compact">
                                            @for (num of playerOptionsForRoom(roomIndex); track num) {
                                                <div
                                                        class="player-option-compact"
                                                        [class.selected]="getPlayersForRoom(roomIndex) === num"
                                                        (click)="selectPlayersForRoom(num, roomIndex)">
                                                    <div class="player-count-compact">{{ num }}</div>
                                                    <div class="player-label-compact">{{ num === 1 ? 'Player' : 'Players' }}</div>
                                                    <div class="player-price-compact"> {{ pricePerPersonFor(num) * num }}
                                                        MKD
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        }

                        @if (totalInclVat() > 0) {
                            <div class="price-summary">
                                <span class="price-label">Total:</span>
                                <span class="price-amount">{{ totalInclVat() }} MKD</span>
                            </div>
                            <div class="price-breakdown">
                                <div class="line small">Net: {{ netPortion() }} MKD</div>
                                <div class="line small">VAT ({{ taxPercentage() }}%): {{ vatPortion() }} MKD</div>
                            </div>
                        }

                        <div class="step-actions">
                            <app-button variant="outline" (clicked)="previousStep()">Back</app-button>
                            <app-button (clicked)="nextStep()" [disabled]="!isStep3Valid()">Continue to Payment
                            </app-button>
                        </div>
                    </div>
                }

                <!-- STEP 4 -->
                @if (currentStep() === 4) {
                    <app-payment-step
                            [date]="formatDate(store.selectedDate())"
                            [time]="store.selectedTime()"
                            [rooms]="store.selectedRooms()"
                            [roomSummaries]="getRoomSummaries()"
                            [totalPlayers]="store.totalPlayers()"
                            [net]="store.netPortion()"
                            [vat]="store.vatPortion()"
                            [total]="store.totalInclVat()"
                            [taxPercent]="store.taxPercentage()"
                            currency="MKD"

                            [paymentMethod]="store.paymentMethod()"
                            (paymentMethodChange)="store.setPaymentMethod($event)"

                            [customer]="store.customerInfo()"
                            (customerChange)="store.setCustomerInfo($event)"

                            [submitting]="submitting()"
                            (back)="previousStep()"
                            (submit)="submitBooking()"
                    />
                }
            </div>
        }
    </div>
</div>
