<div class="booking-page">
    <div class="booking-container">
        <h1 class="page-title">Book Your VR Experience</h1>

        @if (loading()) {
            <app-loading message="Loading..." [fullscreen]="true"></app-loading>
        } @else {
            @if (currentStep() > 1) {
                <div class="selection-summary-bar">
                    <div class="summary-item-bar">
                        <span class="summary-icon">ðŸ“…</span>
                        <div class="summary-info">
                            <span class="summary-label">Date & Time</span>
                            <span class="summary-value">{{ formatDate(selectedDate) }} at {{ selectedTime }}</span>
                        </div>
                    </div>
                    @if (currentStep() >= 2) {
                        <div class="summary-item-bar">
                            <span class="summary-icon">ðŸšª</span>
                            <div class="summary-info">
                                <span class="summary-label">Rooms</span>
                                <span class="summary-value">{{ selectedRooms }} {{ selectedRooms === 1 ? 'Room' : 'Rooms' }}</span>
                            </div>
                        </div>
                    }
                    @if (currentStep() >= 3) {
                        <div class="summary-item-bar">
                            <span class="summary-icon">ðŸŽ®</span>
                            <div class="summary-info">
                                <span class="summary-label">Game(s)</span>
                                <span class="summary-value">{{ getSelectedGamesText() }}</span>
                            </div>
                        </div>
                    }
                </div>
            }

            <div class="booking-steps">
                <div class="steps-indicator">
                    <div class="step" [class.active]="currentStep() >= 1" [class.completed]="currentStep() > 1">
                        <div class="step-number">1</div>
                        <div class="step-label">Choose Date & Time</div>
                    </div>
                    <div class="step-line" [class.completed]="currentStep() > 1"></div>

                    <div class="step" [class.active]="currentStep() >= 2" [class.completed]="currentStep() > 2">
                        <div class="step-number">2</div>
                        <div class="step-label">Select Game</div>
                    </div>
                    <div class="step-line" [class.completed]="currentStep() > 2"></div>

                    <div class="step" [class.active]="currentStep() >= 3" [class.completed]="currentStep() > 3">
                        <div class="step-number">3</div>
                        <div class="step-label">Players & Details</div>
                    </div>
                    <div class="step-line" [class.completed]="currentStep() > 3"></div>

                    <div class="step" [class.active]="currentStep() >= 4">
                        <div class="step-number">4</div>
                        <div class="step-label">Payment</div>
                    </div>
                </div>

                @if (currentStep() === 1) {
                    <div class="step-content">
                        <h2>Select Available Date & Time</h2>
                        <p class="step-description">
                            Choose your preferred date and time. Green slots are available - click to select how many
                            rooms you need.
                        </p>

                        <app-calendar
                                [gameId]="selectedGameId"
                                [lang]="'en'"
                                [maxConcurrentBookings]="maxConcurrentBookings()"
                                (slotSelected)="onSlotSelected($event)"
                                (gamePickRequested)="onGamePickRequested($event)">
                        </app-calendar>

                        <div class="step-actions">
                            <app-button variant="outline" (clicked)="cancel()">Cancel</app-button>
                        </div>
                    </div>
                }

                @if (currentStep() === 2) {
                    <div class="step-content">
                        <h2>Select Your Game{{ selectedRooms > 1 ? 's' : '' }}</h2>

                        @if (selectedRooms > 1) {
                            <p class="step-description">
                                You're booking {{ selectedRooms }} rooms. Select a game for each room (can be the same
                                game multiple times).
                            </p>
                        }

                        @if (selectedRooms === 1) {
                            <div class="games-selection">
                                @for (game of games(); track game.id) {
                                    <div
                                            class="game-select-card"
                                            [class.selected]="isGameSelected(game.id, 0)"
                                            (click)="selectGameForRoom(game.id, 0)">
                                        <img [src]="game.imageUrl" [alt]="game.name" class="game-image"/>
                                        <div class="game-info">
                                            <h3>{{ game.name }}</h3>
                                            <div class="game-meta">
                                                <span>{{ game.duration }} min</span>
                                                <span>{{ game.minPlayers }}-{{ game.maxPlayers }} players</span>
                                                <span>{{ game.difficulty }}</span>
                                            </div>
                                        </div>
                                        @if (isGameSelected(game.id, 0)) {
                                            <div class="selected-badge">âœ“ Selected</div>
                                        }
                                    </div>
                                }
                            </div>
                        } @else {
                            <div class="multi-room-selection">
                                @for (roomIndex of getRoomIndexes(); track roomIndex) {
                                    <div class="room-game-section">
                                        <h3 class="room-title">Room {{ roomIndex + 1 }}</h3>
                                        <div class="games-selection-compact">
                                            @for (game of games(); track game.id) {
                                                <div
                                                        class="game-select-card-compact"
                                                        [class.selected]="isGameSelected(game.id, roomIndex)"
                                                        (click)="selectGameForRoom(game.id, roomIndex)">
                                                    <img [src]="game.imageUrl" [alt]="game.name"
                                                         class="game-image-small"/>
                                                    <div class="game-info-compact">
                                                        <h4>{{ game.name }}</h4>
                                                        <div class="game-meta-small">
                                                            <span>{{ game.difficulty }}</span>
                                                        </div>
                                                    </div>
                                                    @if (isGameSelected(game.id, roomIndex)) {
                                                        <div class="selected-badge-small">âœ“</div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        }

                        <div class="step-actions">
                            <app-button variant="outline" (clicked)="previousStep()">Back</app-button>
                            <app-button (clicked)="nextStep()" [disabled]="!allRoomsHaveGames()">
                                Continue to Players & Details
                            </app-button>
                        </div>
                    </div>
                }

                @if (currentStep() === 3) {
                    <div class="step-content">
                        <h2>Number of Players & Customer Information</h2>

                        @if (selectedRooms === 1) {
                            <div class="form-section">
                                <h3>How many players?</h3>
                                <div class="player-selection">
                                    @for (num of playerOptionsForRoom(0); track num) {
                                        <div
                                                class="player-option"
                                                [class.selected]="getPlayersForRoom(0) === num"
                                                (click)="selectPlayersForRoom(num, 0)">
                                            <div class="player-count">{{ num }}</div>
                                            <div class="player-label">{{ num === 1 ? 'Player' : 'Players' }}</div>
                                            <div class="player-price">{{ getPriceForRoom(num, 0) || 0 }}MKD</div>
                                        </div>
                                    }
                                </div>
                            </div>
                        } @else {
                            <div class="multi-room-players">
                                @for (roomIndex of getRoomIndexes(); track roomIndex) {
                                    <div class="room-player-section">
                                        <h3 class="room-title-small">Room {{ roomIndex + 1 }}
                                            : {{ getGameNameForRoom(roomIndex) }}</h3>
                                        <div class="player-selection-compact">
                                            @for (num of playerOptionsForRoom(roomIndex); track num) {
                                                <div
                                                        class="player-option-compact"
                                                        [class.selected]="getPlayersForRoom(roomIndex) === num"
                                                        (click)="selectPlayersForRoom(num, roomIndex)">
                                                    <div class="player-count-compact">{{ num }}</div>
                                                    <div class="player-label-compact">{{ num === 1 ? 'Player' : 'Players' }}</div>
                                                    <div class="player-price-compact">{{ getPriceForRoom(num, roomIndex) || 0 }}
                                                        MKD
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        }

                        @if (getTotalPrice() > 0) {
                            <div class="price-summary">
                                <span class="price-label">Total Price (All Rooms):</span>
                                <span class="price-amount">{{ getTotalPrice() }} MKD</span>
                            </div>
                        }

                        <div class="form-section">
                            <h3>Your Information</h3>
                            <div class="form-grid">
                                <input type="text" [(ngModel)]="customerInfo.firstName" placeholder="First Name"
                                       class="text-input" required/>
                                <input type="text" [(ngModel)]="customerInfo.lastName" placeholder="Last Name"
                                       class="text-input" required/>
                                <input type="email" [(ngModel)]="customerInfo.email" placeholder="Email"
                                       class="text-input" required/>
                                <input type="tel" [(ngModel)]="customerInfo.phone" placeholder="Phone"
                                       class="text-input" required/>
                            </div>
                        </div>

                        <div class="step-actions">
                            <app-button variant="outline" (clicked)="previousStep()">Back</app-button>
                            <app-button (clicked)="nextStep()" [disabled]="!isStep3Valid()">Continue to Payment
                            </app-button>
                        </div>
                    </div>
                }

                @if (currentStep() === 4) {
                    <div class="step-content">
                        <h2>Payment Method</h2>

                        <div class="booking-summary">
                            <h3>Booking Summary</h3>
                            <div class="summary-item">
                                <span class="label">Date:</span>
                                <span class="value">{{ formatDate(selectedDate) }}</span>
                            </div>
                            <div class="summary-item">
                                <span class="label">Time:</span>
                                <span class="value">{{ selectedTime }}</span>
                            </div>
                            <div class="summary-item">
                                <span class="label">Rooms:</span>
                                <span class="value">{{ selectedRooms }}</span>
                            </div>
                            @for (game of selectedGames(); track game.gameId; let i = $index) {
                                <div class="summary-item">
                                    <span class="label">Room {{ i + 1 }}:</span>
                                    <span class="value">{{ getGameName(game.gameId) }} - {{ game.playerCount }}
                                        players</span>
                                </div>
                            }
                            <div class="summary-item">
                                <span class="label">Total Players:</span>
                                <span class="value">{{ getTotalPlayers() }}</span>
                            </div>
                            <div class="summary-item total">
                                <span class="label">Total:</span>
                                <span class="value">{{ totalPrice() }} MKD</span>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>Choose Payment Method</h3>
                            <div class="payment-methods">
                                <label class="payment-method" [class.selected]="paymentMethod === 'ONLINE'">
                                    <input type="radio" [(ngModel)]="paymentMethod" value="ONLINE"/>
                                    <div class="payment-content">
                                        <div class="payment-icon">ðŸ’³</div>
                                        <div class="payment-info">
                                            <div class="payment-title">Pay Online</div>
                                            <div class="payment-desc">Secure payment via credit/debit card</div>
                                        </div>
                                    </div>
                                </label>

                                <label class="payment-method" [class.selected]="paymentMethod === 'CASH'">
                                    <input type="radio" [(ngModel)]="paymentMethod" value="CASH"/>
                                    <div class="payment-content">
                                        <div class="payment-icon">ðŸ’µ</div>
                                        <div class="payment-info">
                                            <div class="payment-title">Pay with Cash</div>
                                            <div class="payment-desc">Pay when you arrive at the venue</div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="step-actions">
                            <app-button variant="outline" (clicked)="previousStep()">Back</app-button>
                            <app-button (clicked)="submitBooking()" [disabled]="!paymentMethod"
                                        [loading]="submitting()">
                                {{ paymentMethod === 'ONLINE' ? 'Proceed to Payment' : 'Complete Booking' }}
                            </app-button>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>
